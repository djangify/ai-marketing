{% load static %}
<!-- projects/templates/projects/tabs/prompts_tab.html -->
<!-- This template is for the prompts tab in the project management interface. It includes a button to load templates, a button to add a new prompt, and a list of existing prompts. -->
<!-- The prompts are loaded dynamically using HTMX. -->
<div id="prompts-tab" hx-trigger="load" hx-get="{% url 'prompts:prompt_list' project_id=project.id %}" hx-target="#prompt-list-container" hx-swap="innerHTML">
    <!-- Add CSRF token here -->
    {% csrf_token %}
    
    <div class="flex flex-col sm:flex-row items-start justify-between">
        <h2 class="text-xl md:text-2xl lg:text-2xl font-bold mb-4 sm:mb-0">Step 2: Prompts</h2>
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
            <button 
                hx-get="{% url 'prompts:template_selection' project_id=project.id %}"
                hx-target="#modal-container"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                class="bg-[#9810fa]/10 font-semibold hover:bg-[#9810fa]/15 text-sm sm:text-base rounded-lg w-full sm:w-auto h-8 sm:h-10 inline-flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Load Template
            </button>
            <button 
                hx-post="{% url 'prompts:prompt_create' project_id=project.id %}"
                hx-target="#prompt-list-container"
                hx-swap="innerHTML"
                hx-indicator="#loading-indicator"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                class="bg-[#9810fa]/10  font-semibold text-sm sm:text-base rounded-lg w-full sm:w-auto h-8 sm:h-10 inline-flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
                Add Prompt
            </button>
        </div>
    </div>
    <!-- Loading indicator -->
    <div id="loading-indicator" class="htmx-indicator flex justify-center my-4">
        <svg class="animate-spin h-5 w-5 text-[#9810fa]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Prompt list container -->
    <div id="prompt-list-container" class="space-y-6 mt-6">
        <!-- Content will be loaded by HTMX -->
        <div class="text-center py-10">
            <svg class="animate-spin h-8 w-8 text-[#9810fa] mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>Loading prompts...</p>
        </div>
    </div>

    <!-- Modal container for prompt editor and template selection -->
    <div id="modal-container"></div>
</div>

<!-- Confirmation dialog template -->
<template id="delete-confirmation-template">
    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" id="delete-confirmation-modal">
        <div class="max-w-md w-full bg-white rounded-xl p-6 shadow-lg">
            <div class="flex flex-col space-y-4">
                <h3 class="text-lg font-bold">Delete Prompt</h3>
                <p>Are you sure you want to delete this prompt? This action cannot be undone.</p>
                <div class="flex justify-end space-x-2 mt-4">
                    <button class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2" onclick="closeDeleteConfirmation()">
                        Cancel
                    </button>
                    <button id="confirm-delete-button" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90 h-9 px-4 py-2">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    let promptToDelete = null;
    
    function showDeleteConfirmation(promptId) {
        promptToDelete = promptId;
        
        // Clone the template and append to body
        const template = document.getElementById('delete-confirmation-template');
        const modal = template.content.cloneNode(true);
        document.body.appendChild(modal);
        
        // Add event listener to delete button
        document.getElementById('confirm-delete-button').addEventListener('click', confirmDelete);
    }
    
    function closeDeleteConfirmation() {
        const modal = document.getElementById('delete-confirmation-modal');
        if (modal) {
            modal.remove();
        }
        promptToDelete = null;
    }
    
    function confirmDelete() {
        if (!promptToDelete) return;
        
        // Modified to use XMLHttpRequest for better compatibility
        const xhr = new XMLHttpRequest();
        const url = `{% url 'prompts:prompt_delete' project_id=project.id prompt_id='PLACEHOLDER_ID' %}`.replace('PLACEHOLDER_ID', promptToDelete);
        
        xhr.open('DELETE', url, true);
        xhr.setRequestHeader('X-CSRFToken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                closeDeleteConfirmation();
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.status === 'success') {
                            // Manually reload the prompt list container
                            const promptListContainer = document.getElementById('prompt-list-container');
                            htmx.ajax('GET', '{% url "prompts:prompt_list" project_id=project.id %}', {
                                target: promptListContainer,
                                swap: 'innerHTML'
                            });
                            showNotification('Prompt deleted successfully');
                        } else {
                            showNotification('Error: ' + (response.message || 'Unknown error'), 'error');
                        }
                    } catch (e) {
                        showNotification('Error parsing response', 'error');
                    }
                } else {
                    showNotification('Error: HTTP status ' + xhr.status, 'error');
                }
            }
        };
        
        xhr.send();
    }
    
    function openPromptEditor(promptId) {
        htmx.ajax('GET', `{% url 'prompts:prompt_edit' project_id=project.id %}?prompt_id=${promptId}`, {
            target: '#modal-container',
            swap: 'innerHTML'
        });
    }
    
    // Handle click outside of modals to close them
    document.addEventListener('click', function(event) {
        // Check for delete confirmation modal
        const deleteModal = document.getElementById('delete-confirmation-modal');
        if (deleteModal && !event.target.closest('.max-w-md') && event.target.closest('#delete-confirmation-modal')) {
            closeDeleteConfirmation();
        }
        
        // Check for prompt editor modal
        const promptEditor = document.getElementById('prompt-editor-modal');
        if (promptEditor && !event.target.closest('.max-w-[90%]') && event.target.closest('#prompt-editor-modal')) {
            closePromptEditor();
        }
        
        // Check for template selection modal
        const templateModal = document.getElementById('template-selection-modal');
        if (templateModal && !event.target.closest('.max-w-[90%]') && event.target.closest('#template-selection-modal')) {
            closeTemplateModal();
        }
    });
    
    function closePromptEditor() {
        const modal = document.getElementById('prompt-editor-modal');
        if (modal) {
            modal.remove();
        }
    }
    
    function closeTemplateModal() {
        const modal = document.getElementById('template-selection-modal');
        if (modal) {
            modal.remove();
        }
    }
    
    // Helper function to show notifications
    function showNotification(message, type = 'success') {
        // Simple alert for now, can be replaced with a more sophisticated notification system later
        alert(message);
    }
</script>
